<html>
  <head>
    <meta charset="utf-8" />
    <title>Keyboard Layout 3D Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/101/three.min.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/STLLoader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css">
  </head>
  <body>
    <div class="container">
      <section class="section">
        <h1 class="title">Keyboard Layout 3D Viewer</h1>
        <div id="app">
          <div class="field">
            <label class="label">Keyboard Layout Editor JSON data (Raw data is not supported)</label>
            <div class="control">
              <textarea v-model="jsondata" placeholder="JSON data" class="textarea"></textarea>
            </div>
          </div>
          <div class="field is-grouped">
            <div class="control">
              <label class="radio">
                <input type="radio" value="perspective" v-model="camera">
                Perspective camera
              </label>
              <label class="radio">
                <input type="radio" value="ortographic" v-model="camera">
                Orthographic camera
              </label>
            </div>
            <div class="control">
              <button id="renderBtn" v-on:click="renderKB" class="button is-dark">Render</button>
            </div>
          </div>
          <div id="container"></div>
        </div>
      </section>
      <footer class="footer">
        <div class="content has-text-centered">
          <p>
            <strong>Keyboard Layout 3D Viewer</strong> by <a href="https://github.com/eswai/">eswai</a>. The source code is licensed
            <a href="http://opensource.org/licenses/mit-license.php">MIT</a>. SA keycaps (c) 2017 <a href="https://github.com/hineybush">Josh Hinnebusch.</a>
          </p>
        </div>
      </footer>
    </div>
  </body>

  <script type="text/javascript">
    var app = new Vue({
      el: '#app',
      data: {
        keycaps: {},
        switch: '',
        pcb: '',
        camera: "perspective",
        jsondata: "[[{\"x\":3.5,\"c\":\"#2840dd\",\"p\":\"SA R1\",\"a\":7},\"\",{\"x\":10.5},\"\"],[{\"y\":-0.875,\"x\":2.5},\"\",{\"x\":1},\"\",{\"x\":8.5},\"\",{\"x\":1},\"\"],[{\"y\":-0.875,\"x\":5.5},\"\",\"\",{\"x\":4.5},\"\",\"\"],[{\"y\":-0.875,\"w\":1.5},\"\",\"\",{\"x\":14.5},\"\",{\"w\":1.5},\"\"],[{\"y\":-0.375,\"x\":3.5,\"c\":\"#5c6cc3\",\"p\":\"SA R2\"},\"\",{\"x\":10.5},\"\"],[{\"y\":-0.875,\"x\":2.5},\"\",{\"x\":1},\"\",{\"x\":8.5},\"\",{\"x\":1},\"\"],[{\"y\":-0.875,\"x\":5.5},\"\",{\"p\":\"SA R3\",\"h\":1.5},\"\",{\"x\":4.5,\"h\":1.5},\"\",{\"p\":\"SA R2\"},\"\"],[{\"y\":-0.875,\"w\":1.5},\"\",\"\",{\"x\":14.5},\"\",{\"w\":1.5},\"\"],[{\"y\":-0.375,\"x\":3.5,\"c\":\"#4284c8\"},\"\",{\"x\":10.5},\"\"],[{\"y\":-0.875,\"x\":2.5,\"p\":\"SA R3\"},\"\",{\"x\":1},\"\",{\"x\":8.5},\"\",{\"x\":1},\"\"],[{\"y\":-0.875,\"x\":5.5},\"\",{\"x\":6.5},\"\"],[{\"y\":-0.875,\"w\":1.5},\"\",\"\",{\"x\":14.5},\"\",{\"w\":1.5},\"\"],[{\"y\":-0.625,\"x\":6.5,\"c\":\"#65b7ec\",\"h\":1.5},\"\",{\"x\":4.5,\"h\":1.5},\"\"],[{\"y\":-0.75,\"x\":3.5,\"p\":\"SA R4\"},\"\",{\"x\":10.5},\"\"],[{\"y\":-0.875,\"x\":2.5},\"\",{\"x\":1},\"\",{\"x\":8.5},\"\",{\"x\":1},\"\"],[{\"y\":-0.875,\"x\":5.5},\"\",{\"x\":6.5},\"\"],[{\"y\":-0.875,\"w\":1.5},\"\",\"\",{\"x\":14.5},\"\",{\"w\":1.5},\"\"],[{\"y\":-0.375,\"x\":3.5,\"c\":\"#81d7e2\",\"p\":\"SA R3\"},\"\",{\"x\":10.5},\"\"],[{\"y\":-0.875,\"x\":2.5},\"\",{\"x\":1},\"\",{\"x\":8.5},\"\",{\"x\":1},\"\"],[{\"y\":-0.75,\"x\":0.5},\"\",\"\",{\"x\":14.5},\"\",\"\"],[{\"r\":30,\"rx\":6.5,\"ry\":4.25,\"y\":-1,\"x\":1,\"c\":\"#4e4c4c\"},\"\",\"\"],[{\"h\":2},\"\",{\"h\":2},\"\",\"\"],[{\"x\":2},\"\"],[{\"r\":-30,\"rx\":13,\"y\":-1,\"x\":-3},\"\",\"\"],[{\"x\":-3},\"\",{\"h\":2},\"\",{\"h\":2},\"\"],[{\"x\":-3},\"\"]]"
      },

      created: function() {
        console.log("Loading keycaps...")
        var loader = new THREE.STLLoader();
        loader.setPath('./keycaps/');
        loader.load('original.stl', k => {
          this.keycaps['Original'] = k
        })
        loader.load('sa-1u-r1.stl', k => {
          this.keycaps['SA R1'] = k
        })
        loader.load('sa-1u-r2.stl', k => {
          this.keycaps['SA R2'] = k
        })
        loader.load('sa-1u-r3.stl', k => {
          this.keycaps['SA R3'] = k
        })
        loader.load('sa-1u-r4.stl', k => {
          this.keycaps['SA R4'] = k
        })
        loader.load('sa-7u-space.stl', k => {
          this.keycaps['SA SPACE'] = k
        })
        loader.load('pcb.stl', k => {
          this.pcb = k
        })
        loader.load('switch.stl', k => {
          this.switch = k
        })
      },

      methods: {
        renderKB: function() {
          var that = this
          const width = 960;
          const height = 540;

          var container = document.getElementById( 'container' );
          container.innerHTML = "";

          var renderer = new THREE.WebGLRenderer( { antialias: true } );
          renderer.setPixelRatio( window.devicePixelRatio );
          renderer.setSize( width, height );
          renderer.gammaOutput = true;
          renderer.gammaFactor = 2.2;

          container.appendChild( renderer.domElement );
          scene = new THREE.Scene();
          scene.background = new THREE.Color( 0xf9f9f9 );
          if (this.camera == "perspective") {
            var camera = new THREE.PerspectiveCamera( 45, width / height, 1, 2000 );
          } else {
            var camera = new THREE.OrthographicCamera( width / - 2, width / 2, height / 2, height / - 2, 1, 2000 );
          }
          camera.position.set( 0, 1000, 0 );

          controls = new THREE.OrbitControls( camera, renderer.domElement );
          controls.target.set( 0, 0.5, 0 );

          scene.add( new THREE.AmbientLight( 0x404040 ) );
          pointLight = new THREE.PointLight( 0xffffff, 1 );
          pointLight.position.set( -1000, 700, -1000 );
          scene.add( pointLight );

          const plane = new THREE.GridHelper(1900, 100, 0x888888, 0x888888);
          plane.position.y = -20;
          scene.add(plane);

          const keylayout = JSON.parse(this.jsondata)

          var x = 0;
          var y = 0;
          var w = 1;
          var h = 1;
          var r = 0;
          var rx = 0;
          var ry = 0;
          var p = "Original";
          var c = 0x999999;

          keylayout.forEach(function(row){
            if (Array.isArray(row)) {
              row.forEach(function(key){
                if (typeof key == 'string') {
                  console.log('x:' + x + ' y:' + y + ' rx: ' + rx + ' ry: ' + ry + ' r: ' + r + ' key: ' + key);

                  px = (rx + Math.cos(r) * x - Math.sin(r) * y) * 19 - 190;
                  pz = (ry + Math.sin(r) * x + Math.cos(r) * y) * 19 - 95;
                  sx = w * 19 / 18.5 - 1 / 18.5 ;
                  sz = h * 19 / 18.5 - 1 / 18.5;

                  var geometry = that.keycaps[p];
                  var material = new THREE.MeshStandardMaterial({color: c, metalness: 0.1, roughness: 0.2});;
                  var kc = new THREE.Mesh( geometry, material );
                  kc.position.x = px;
                  kc.position.z = pz;
                  kc.scale.x = sx;
                  kc.scale.z = sz;
                  kc.rotation.y = -r;
                  scene.add(kc);

                  var material = new THREE.MeshStandardMaterial({color: 0xf0ffff, metalness: 0.5, roughness: 0.5});;
                  var pcb1 = new THREE.Mesh( that.pcb, material );
                  pcb1.position.x = px;
                  pcb1.position.y = -7
                  pcb1.position.z = pz;
                  pcb1.scale.x = sx;
                  pcb1.scale.z = sz;
                  pcb1.rotation.y = -r;
                  scene.add(pcb1);

                  var pcb2 = pcb1.clone()
                  pcb2.position.y = -12
                  scene.add(pcb2);

                  var pcb3 = pcb1.clone()
                  pcb3.position.y = -16
                  scene.add(pcb3);

                  var material = new THREE.MeshStandardMaterial({color: 0x111111, metalness: 0.5, roughness: 0.7});;
                  var sw = new THREE.Mesh( that.switch, material );
                  sw.position.x = (rx + Math.cos(r) * (x + (w - 1) / 2) - Math.sin(r) * (y + (h - 1) / 2)) * 19 - 190;
                  sw.position.y = -5
                  sw.position.z = (ry + Math.sin(r) * (x + (w - 1) / 2) + Math.cos(r) * (y + (h - 1) / 2)) * 19 - 95;
                  sw.rotation.y = -r;
                  scene.add(sw);

                  x += w;
                  w = 1;
                  h = 1;
                } else {
                  w = key.w ? key.w : 1;
                  h = key.h ? key.h : 1;
                  x = key.x ? x + key.x : x;
                  y = key.y ? y + key.y : y;
                  p = that.keycaps[key.p] ? key.p : p;
                  c = key.c ? parseInt(key.c.replace('#', '0x')) : c;
                  if (key.r || key.rx || key.ry) {
                    r = key.r ? key.r / 180 * Math.PI : r;
                    rx = key.rx ? key.rx : rx;
                    ry = key.ry ? key.ry : ry;
                    x = key.x ? key.x : 0;
                    y = key.y ? key.y : 0;
                  };
                }
              });
              x = 0;
              y += 1;
              w = 1;
              h = 1;
            }
          });

          tick();

          function tick() {
            renderer.render(scene, camera);
            requestAnimationFrame(tick);
          }
        }
      }
    })
  </script>
</html>
