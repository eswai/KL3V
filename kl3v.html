<html>
  <head>
    <meta charset="utf-8" />
    <title>Keyboard Layout 3D Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/101/three.min.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/STLLoader.js"></script>
    <script src="js/KLEparser.js"></script>
    <script src="https://unpkg.com/vue-swatches"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://unpkg.com/vue-swatches/dist/vue-swatches.min.css">
  </head>
  <body>
    <div class="container">
      <section class="section">
        <h1 class="title">Keyboard Layout 3D Viewer</h1>
        <div id="app">
          <div class="field">
            <label class="label">Keyboard Layout Editor Raw data (Raw data is now supported!)</label>
            <div class="control">
              <textarea v-model="rawdata" placeholder="JSON data" class="textarea"></textarea>
            </div>
          </div>

          <div class="field is-grouped">
            <div class="field is-horizontal">
              <div class="label">
                PCB color
              </div>
              <div class="control">
                <swatches v-model="pcbcolor" :colors="colors" shapes="circles"  inline popover-to="left"></swatches>
              </div>
            </div>

            <div class="control">
              <label class="radio">
                <input type="radio" value="perspective" v-model="camera">
                Perspective camera
              </label>
              <label class="radio">
                <input type="radio" value="ortographic" v-model="camera">
                Orthographic camera
              </label>
            </div>

            <div class="control">
              <button id="renderBtn" v-on:click="renderKB" class="button is-dark">Render</button>
            </div>
            
          </div>
          <div id="container"></div>
        </div>
      </section>
      <article class="message">
        <div class="message-body">
          <div class="content">
            <p>Supported keycap profile</p>
            <ul>
              <li>SA R1, R2, R3, R4, SPACE</li>
              <li>DSA</li>
              <li>XDA</li>
              <li>Kailh Chocolate "Choc"</li>
            </ul>
          </div>
        </div>
      </article>
      <footer class="footer">
        <div class="content has-text-centered">
          <p>
            <strong>Keyboard Layout 3D Viewer</strong> by <a href="https://github.com/eswai/">eswai</a>. The source code is licensed
            <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.
            SA keycaps (c) <a href="https://github.com/hineybush">Josh Hinnebusch.</a>
            Cherry MX switch (c) <a href="https://grabcad.com/library/cherry-mx-1">Mirko Tadic.</a>
          </p>
        </div>
      </footer>
    </div>
  </body>

  <script type="text/javascript">
    var app = new Vue({
      el: '#app',
      components: {Swatches: window.VueSwatches.default},
      data: {
        keycaps: {},
        mxswitch: '',
        chocswitch: '',
        pcb: '',
        pcbcolor: '#EEEEEE',
        colors: ['#EEEEEE', '#6A0888', '#B40404', '#151515', '#088A08', '#08298A', "#AEB404"],
        camera: "perspective",
        renderer: false,
        scene: false,
        cameraobj: false,
        tobj: [],
        rawdata: "[{x:3.5,c:\"#2840dd\",p:\"SA R1\",a:7},\"\",{x:10.5},\"\"],[{y:-0.875,x:2.5},\"\",{x:1},\"\",{x:8.5},\"\",{x:1},\"\"],[{y:-0.875,x:5.5},\"\",\"\",{x:4.5},\"\",\"\"],[{y:-0.875,w:1.5},\"\",\"\",{x:14.5},\"\",{w:1.5},\"\"],[{y:-0.375,x:3.5,c:\"#5c6cc3\",p:\"SA R2\"},\"\",{x:10.5},\"\"],[{y:-0.875,x:2.5},\"\",{x:1},\"\",{x:8.5},\"\",{x:1},\"\"],[{y:-0.875,x:5.5},\"\",{p:\"SA R3\",h:1.5},\"\",{x:4.5,h:1.5},\"\",{p:\"SA R2\"},\"\"],[{y:-0.875,w:1.5},\"\",\"\",{x:14.5},\"\",{w:1.5},\"\"],[{y:-0.375,x:3.5,c:\"#4284c8\"},\"\",{x:10.5},\"\"],[{y:-0.875,x:2.5,p:\"SA R3\"},\"\",{x:1},\"\",{x:8.5},\"\",{x:1},\"\"],[{y:-0.875,x:5.5},\"\",{x:6.5},\"\"],[{y:-0.875,w:1.5},\"\",\"\",{x:14.5},\"\",{w:1.5},\"\"],[{y:-0.625,x:6.5,c:\"#65b7ec\",h:1.5},\"\",{x:4.5,h:1.5},\"\"],[{y:-0.75,x:3.5,p:\"SA R4\"},\"\",{x:10.5},\"\"],[{y:-0.875,x:2.5},\"\",{x:1},\"\",{x:8.5},\"\",{x:1},\"\"],[{y:-0.875,x:5.5},\"\",{x:6.5},\"\"],[{y:-0.875,w:1.5},\"\",\"\",{x:14.5},\"\",{w:1.5},\"\"],[{y:-0.375,x:3.5,c:\"#81d7e2\",p:\"XDA\"},\"\",{x:10.5},\"\"],[{y:-0.875,x:2.5},\"\",{x:1},\"\",{x:8.5},\"\",{x:1},\"\"],[{y:-0.75,x:0.5},\"\",\"\",{x:14.5},\"\",\"\"],[{r:30,rx:6.5,ry:4.25,y:-1,x:1,c:\"#4e4c4c\",p:\"DSA\"},\"\",\"\"],[{h:2},\"\",{h:2},\"\",\"\"],[{x:2},\"\"],[{r:-30,rx:13,y:-1,x:-3,c:\"#483527\",p:\"Choc\"},\"\",\"\"],[{x:-3},\"\",{h:2},\"\",{h:2},\"\"],[{x:-3},\"\"]"
      },

      created: function() {
        var that = this
        console.log("Loading keycaps...")
        var loader = new THREE.STLLoader()
        loader.setPath('./models/')
        this.keycaps = {
          'DSA': 'dsa.stl',
          'XDA': 'xda.stl',
          'SA R1': 'sa-1u-r1.stl',
          'SA R2': 'sa-1u-r2.stl',
          'SA R3': 'sa-1u-r3.stl',
          'SA R4': 'sa-1u-r4.stl',
          'SA SPACE': 'sa-7u-space.stl',
          'Choc': 'choc.stl'
        }
        Object.keys(that.keycaps).forEach(kn => {
          loader.load(that.keycaps[kn], stl => {
            this.keycaps[kn] = stl
          })
        })
        loader.load('pcb.stl', stl => {
          this.pcb = stl
        })
        loader.load('mx-switch.stl', stl => {
          this.mxswitch = stl
        })
        loader.load('choc-switch.stl', stl => {
          this.chocswitch = stl
        })
      },

      methods: {
        renderKB: function() {
          var that = this
          const width = 960
          const height = 540

          var container = document.getElementById( 'container' )

          while (that.tobj.length > 0) {
            that.scene.remove(that.tobj.shift())
          }
          var renderer
          var camera
          var controls
          if (that.renderer == false) {
            renderer = new THREE.WebGLRenderer( { antialias: true } )
            that.renderer = renderer
            renderer.setPixelRatio( window.devicePixelRatio )
            renderer.setSize( width, height )
            renderer.gammaOutput = true
            renderer.gammaFactor = 2.2

            container.appendChild( renderer.domElement )
            scene = new THREE.Scene()
            that.scene = scene
            scene.background = new THREE.Color( 0xf0f0f0 )
            if (this.camera == "perspective") {
              camera = new THREE.PerspectiveCamera( 45, width / height, 1, 2000 )
            } else {
              camera = new THREE.OrthographicCamera( width / - 2, width / 2, height / 2, height / - 2, 1, 2000 )
            }
            that.cameraobj = camera
            camera.position.set( 0, 600, 0 )

            controls = new THREE.OrbitControls( camera, renderer.domElement )
            controls.target.set( 0, 0.5, 0 )
            // controls.object.position.set( 200, 500, 100 )

            scene.add( new THREE.AmbientLight( 0x404040 ) )
            pointLight = new THREE.PointLight( 0xffffff, 1 )
            pointLight.position.set( 0, 2000, 800 )
            scene.add( pointLight )

            const plane = new THREE.GridHelper(1900, 100, 0x888888, 0x888888)
            plane.position.y = -20
            scene.add(plane)
          } else {
            renderer = that.renderer
            scene = that.scene
            camera = that.cameraobj
          }

          var kb = KLEparser(that.rawdata)
          kb.keys.forEach(function(key){
            var geometry = that.keycaps[key.p]
            if (!geometry) {
              geometry = that.keycaps["DSA"]
            }
            var material = new THREE.MeshStandardMaterial({color: key.c, metalness: 0.1, roughness: 0.2})
            var kc = new THREE.Mesh( geometry, material )
            kc.position.x = key.centerX() * 19
            kc.position.z = key.centerY() * 19
            kc.scale.x = key.scaleW()
            kc.scale.z = key.scaleH()
            kc.rotation.y = -key.r
            scene.add(kc)
            that.tobj.push(kc)

            var material = new THREE.MeshStandardMaterial({color: that.pcbcolor, metalness: 0.1, roughness: 0.5})
            var pcb1 = new THREE.Mesh( that.pcb, material )
            var sx = key.w * 19 / 23 + 4 / 23
            var sz = key.h * 19 / 23 + 4 / 23
            pcb1.position.x = key.centerX() * 19
            pcb1.position.y = -7
            pcb1.position.z = key.centerY() * 19
            pcb1.scale.x = sx
            pcb1.scale.z = sz
            pcb1.rotation.y = -key.r
            scene.add(pcb1)
            that.tobj.push(pcb1)

            var pcb2 = pcb1.clone()
            pcb2.position.y = -12
            scene.add(pcb2)
            that.tobj.push(pcb2)

            var pcb3 = pcb1.clone()
            pcb3.position.y = -16
            scene.add(pcb3)
            that.tobj.push(pcb3)

            var material = new THREE.MeshStandardMaterial({color: 0x111111, metalness: 0.5, roughness: 0.7})
            var sw
            if (key.p == "Choc") {
              sw = new THREE.Mesh( that.chocswitch, material )
            } else {
              sw = new THREE.Mesh( that.mxswitch, material )
            }
            sw.position.x = key.centerX() * 19
            sw.position.y = -5
            sw.position.z = key.centerY() * 19
            sw.rotation.y = -key.r
            scene.add(sw)
            that.tobj.push(sw)
          })

          tick()

          function tick() {
            renderer.render(scene, camera)
            requestAnimationFrame(tick)
          }
        }
      }
    })
  </script>
</html>
